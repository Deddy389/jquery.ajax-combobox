(function(b){b.fn.ajaxComboBox=function(d,c){return this.each(function(){a(this,d,c)})};function a(q,y,Q){var f=R(y,Q);var s=A();var G=v();var x=m();var C=r(q);b.ajaxSetup({cache:false});e();j();p();d();S();N();return true;function R(Z,Y){Y=b.extend({source:Z,lang:"ja",plugin_type:"combobox",init_record:false,db_table:"tbl",field:"name",and_or:"AND",order_by:"ASC",per_page:10,navi_num:5,primary_key:"id",button_img:"acbox/jquery.ajaxComboBox.button.png",bind_to:false,navi_simple:false,sub_info:false,sub_as:{},show_field:"",hide_field:"",select_only:false},Y);Y=b.extend({search_field:Y.field,order_field:Y.field},Y);Y.and_or=Y.and_or.toUpperCase();var X=["hide_field","show_field","order_field","search_field"];for(var aa=0;aa<X.length;aa++){Y[X[aa]]=Y[X[aa]].replace(/[\s　]+/g,"").split(",")}return Y}function A(){switch(f.lang){case"en":return{add_btn:"Add button",add_title:"add a box",del_btn:"Del button",del_title:"delete a box",next:"Next",next_title:"Next"+f.per_page+" (Right key)",prev:"Prev",prev_title:"Prev"+f.per_page+" (Left key)",first_title:"First (Shift + Left key)",last_title:"Last (Shift + Right key)",get_all_btn:"Get All (Down key)",get_all_alt:"(button)",close_btn:"Close (Tab key)",close_alt:"(button)",loading:"loading...",loading_alt:"(loading)",page_info:"num_page_top - num_page_end of cnt_whole",select_ng:"Attention : Please choose from among the list.",select_ok:"OK : Correctly selected.",not_found:"not found"};break;case"es":return{add_btn:"Agregar boton",add_title:"Agregar una opcion",del_btn:"Borrar boton",del_title:"Borrar una opcion",next:"Siguiente",next_title:"Proximas "+f.per_page+" (tecla derecha)",prev:"Anterior",prev_title:"Anteriores "+f.per_page+" (tecla izquierda)",first_title:"Primera (Shift + Left)",last_title:"Ultima (Shift + Right)",get_all_btn:"Ver todos (tecla abajo)",get_all_alt:"(boton)",close_btn:"Cerrar (tecla TAB)",close_alt:"(boton)",loading:"Cargando...",loading_alt:"(Cargando)",page_info:"num_page_top - num_page_end de cnt_whole",select_ng:"Atencion: Elija una opcion de la lista.",select_ok:"OK: Correctamente seleccionado.",not_found:"no encuentre"};break;default:return{add_btn:"追加ボタン",add_title:"入力ボックスを追加します",del_btn:"削除ボタン",del_title:"入力ボックスを削除します",next:"次へ",next_title:"次の"+f.per_page+"件 (右キー)",prev:"前へ",prev_title:"前の"+f.per_page+"件 (左キー)",first_title:"最初のページへ (Shift + 左キー)",last_title:"最後のページへ (Shift + 右キー)",get_all_btn:"全件取得 (下キー)",get_all_alt:"画像:ボタン",close_btn:"閉じる (Tabキー)",close_alt:"画像:ボタン",loading:"読み込み中...",loading_alt:"画像:読み込み中...",page_info:"num_page_top - num_page_end 件 (全 cnt_whole 件)",select_ng:"注意 : リストの中から選択してください",select_ok:"OK : 正しく選択されました。",not_found:"(0 件)"}}}function v(){var X={container:"ac_container",container_open:"ac_container_open",selected:"ac_selected",re_area:"ac_result_area",navi:"ac_navi",results:"ac_results",re_off:"ac_results_off",select:"ac_over",sub_info:"ac_subinfo",select_ok:"ac_select_ok",select_ng:"ac_select_ng"};switch(f.plugin_type){case"combobox":X=b.extend(X,{button:"ac_button",btn_on:"ac_btn_on",btn_out:"ac_btn_out",input:"ac_input",input_off:"ac_input_off"});break;case"simple":X=b.extend(X,{button:"ac_s_button",btn_on:"ac_s_btn_on",btn_out:"ac_s_btn_out",input:"ac_s_input",input_off:"ac_s_input_off"});break}return X}function m(){var X={timer_valchange:false,is_suggest:false,page_all:1,page_suggest:1,max_all:1,max_suggest:1,is_paging:false,is_loading:false,reserve_btn:false,reserve_click:false,xhr:false,key_paging:false,key_select:false,prev_value:"",size_navi:null,size_results:null,size_li:null,size_left:null};if(f.sub_info){if(f.show_field&&!f.hide_field){X.select_field=f.field+","+f.show_field.join(",")}else{X.select_field="*"}}else{X.select_field=f.field;f.hide_field=""}if(f.select_only&&X.select_field!="*"){X.select_field+=","+f.primary_key}return X}function r(Z){var Y={};Y.combo_input=b(Z).attr("autocomplete","off").addClass(G.input).wrap("<div>");Y.container=b(Y.combo_input).parent().addClass(G.container);Y.button=b("<div>").addClass(G.button);Y.img=b("<img>").attr("src",f.button_img);Y.clear=b("<div>").css("clear","left");Y.result_area=b("<div>").addClass(G.re_area);Y.navi=b("<div>").addClass(G.navi);Y.navi_info=b("<div>").addClass("info");Y.navi_p=b("<p>");Y.results=b("<ul>").addClass(G.results);Y.sub_info=b("<div>").addClass(G.sub_info);var aa=(b(Y.combo_input).attr("name")!=undefined)?b(Y.combo_input).attr("name"):b(Y.combo_input).attr("id");aa+="_primary_key";Y.hidden=b('<input type="hidden" />').attr({name:aa,id:aa}).val("");b(Y.container).append(Y.button).append(Y.clear).append(Y.result_area).append(Y.hidden);b(Y.button).append(Y.img);b(Y.result_area).append(Y.navi).append(Y.results).append(Y.sub_info);b(Y.navi).append(Y.navi_info).append(Y.navi_p);if(f.plugin_type=="combobox"){var X=b(Y.combo_input).outerWidth()+b(Y.button).outerWidth()}else{var X=b(Y.combo_input).outerWidth()}b(Y.container).width(X);b(Y.button).height(b(Y.combo_input).innerHeight());b(Y.result_area).width(b(Y.container).width()-(b(Y.result_area).outerWidth()-b(Y.result_area).innerWidth())).css({top:b(Y.container).outerHeight()+b(Y.container).offset().top});return Y}function e(){if(f.select_only){if(b(C.combo_input).val()!=""){if(b(C.hidden).val()!=""){b(C.combo_input).attr("title",s.select_ok).removeClass(G.select_ng).addClass(G.select_ok)}else{b(C.combo_input).attr("title",s.select_ng).removeClass(G.select_ok).addClass(G.select_ng)}}else{b(C.hidden).val("");b(C.combo_input).removeAttr("title").removeClass(G.select_ng)}}b(C.button).attr("title",s.get_all_btn);b(C.img).attr("src",f.button_img)}function j(){var Y=b(C.button).innerWidth();var ac=b(C.button).innerHeight();var X=b(C.img).width();var Z=b(C.img).height();var ab=Y/2-(X/2);var aa=ac/2-(Z/2);b(C.img).css({top:aa,left:ab})}function p(){if(f.init_record===false){return}b(C.hidden).val(f.init_record);if(typeof f.source=="object"){for(var Y=0;Y<f.source.length;Y++){if(f.source[Y][f.primary_key]==f.init_record){var Z=f.source[Y];break}}X(Z)}else{b.getJSON(f.source,{db_table:f.db_table,field:f.field,pkey_name:f.primary_key,pkey_val:f.init_record},X)}function X(aa){b(C.combo_input).val(aa[f.field]);b(C.hidden).val(aa[f.primary_key]);x.prev_value=aa[f.field];if(f.select_only){b(C.combo_input).attr("title",s.select_ok).removeClass(G.select_ng).addClass(G.select_ok)}}}function d(){b(C.button).mouseup(function(X){if(b(C.result_area).is(":hidden")){clearInterval(x.timer_valchange);x.is_suggest=false;n();b(C.combo_input).focus()}else{c()}X.stopPropagation()}).mouseover(function(){b(C.button).addClass(G.btn_on).removeClass(G.btn_out)}).mouseout(function(){b(C.button).addClass(G.btn_out).removeClass(G.btn_on)}).mouseout()}function S(){if(window.opera){b(C.combo_input).keypress(B)}else{b(C.combo_input).keydown(B)}b(C.combo_input).focus(function(){k()}).click(function(){w();b(C.results).children("li").removeClass(G.select)})}function N(){var X=false;b(C.container).mousedown(function(Y){X=true});b("html").mousedown(function(){if(X){X=false}else{c()}})}function o(){b(C.results).children("li").mouseover(function(){if(x.key_select){x.key_select=false;return}u(this);b(C.results).children("li").removeClass(G.select);b(this).addClass(G.select);V()}).click(function(X){if(x.key_select){x.key_select=false;return}X.preventDefault();X.stopPropagation();D(false)})}function K(){b(C.navi).find(".navi_first").mouseup(function(X){b(C.combo_input).focus();X.preventDefault();t()});b(C.navi).find(".navi_prev").mouseup(function(X){b(C.combo_input).focus();X.preventDefault();J()});b(C.navi).find(".navi_page").mouseup(function(X){b(C.combo_input).focus();X.preventDefault();if(!x.is_suggest){x.page_all=parseInt(b(this).text(),10)}else{x.page_suggest=parseInt(b(this).text(),10)}x.is_paging=true;n()});b(C.navi).find(".navi_next").mouseup(function(X){b(C.combo_input).focus();X.preventDefault();W()});b(C.navi).find(".navi_last").mouseup(function(X){b(C.combo_input).focus();X.preventDefault();l()})}function O(){b(C.navi_info).text(s.loading);if(b(C.results).children("dl").is(":hidden")){b(C.results).empty();b(C.sub_info).empty();b(C.result_area).show();b(C.container).addClass(G.container_open)}}function h(ad){var X=H();var af=(X&&!ad)?X.offset().top:b(C.container).offset().top;var aa;if(f.sub_info){var Z=b(C.sub_info).children("dl:visible");aa=b(Z).height()+parseInt(b(Z).css("border-top-width"),10)+parseInt(b(Z).css("border-bottom-width"),10)}else{x.size_li=b(C.results).children("li:first").outerHeight();aa=x.size_li}var ac=document.documentElement.clientHeight;var ab=(document.documentElement.scrollTop>0)?document.documentElement.scrollTop:document.body.scrollTop;var Y=ab+ac-aa;var ae;if(b(X).length){if(af<ab||aa>ac){ae=af-ab}else{if(af>Y){ae=af-Y}else{return}}}else{if(af<ab){ae=af-ab}}window.scrollBy(0,ae)}function w(){b(C.results).addClass(G.re_off);b(C.combo_input).removeClass(G.input_off);b(C.sub_info).children("dl").hide()}function V(){b(C.results).removeClass(G.re_off);b(C.combo_input).addClass(G.input_off)}function k(){x.timer_valchange=setTimeout(E,500)}function E(){var X=b(C.combo_input).val();if(X!=x.prev_value){x.prev_value=X;b(C.combo_input).removeAttr("sub_info");b(C.hidden).val("");if(f.select_only){e()}x.page_suggest=1;x.is_suggest=true;n()}k()}function B(X){if((b.inArray(X.keyCode,[27,38,40,9])>-1&&b(C.result_area).is(":visible"))||(b.inArray(X.keyCode,[37,39,13,9])>-1&&H())||X.keyCode==40){X.preventDefault();X.stopPropagation();X.cancelBubble=true;X.returnValue=false;switch(X.keyCode){case 37:if(X.shiftKey){t()}else{J()}break;case 38:x.key_select=true;U();break;case 39:if(X.shiftKey){l()}else{W()}break;case 40:if(b(C.results).children("li").length){x.key_select=true;g()}else{x.is_suggest=false;n()}break;case 9:x.key_paging=true;c();break;case 13:D(true);break;case 27:x.key_paging=true;c();break}}else{if(X.keyCode!=16){w()}E()}}function P(){if(x.xhr){x.xhr.abort();x.xhr=false}}function n(){var Y=(x.is_suggest)?b.trim(b(C.combo_input).val()):"";if(Y.length<1&&x.is_suggest){c();return}Y=Y.split(/[\s　]+/);P();O();b(C.sub_info).children("dl").hide();if(x.is_paging){var Z=H();if(Z){x.is_paging=b(C.results).children("li").index(Z)}else{x.is_paging=-1}}else{if(!x.is_suggest){x.is_paging=0}}var X=(x.is_suggest)?x.page_suggest:x.page_all;if(typeof f.source=="object"){I(Y,X)}else{z(Y,X)}}function z(Y,X){x.xhr=b.getJSON(f.source,{q_word:Y,page_num:X,per_page:f.per_page,search_field:f.search_field,and_or:f.and_or,select_field:x.select_field,order_field:f.order_field,order_by:f.order_by,primary_key:f.primary_key,db_table:f.db_table},function(Z){Z.candidate=[];Z.primary_key=[];Z.subinfo=[];if(typeof Z.result!="object"){x.xhr=null;F();return}Z.cnt_page=Z.result.length;for(i=0;i<Z.cnt_page;i++){Z.subinfo[i]=[];for(key in Z.result[i]){if(key==f.primary_key){Z.primary_key.push(Z.result[i][key])}if(key==f.field){Z.candidate.push(Z.result[i][key])}else{if(b.inArray(key,f.hide_field)==-1){if(f.show_field!=""&&b.inArray("*",f.show_field)==-1&&b.inArray(key,f.show_field)==-1){continue}else{Z.subinfo[i][key]=Z.result[i][key]}}}}}delete (Z.result);x.xhr=null;M(Z,Y,X)})}function I(ad,ah){var af=[];var aa=[];var X=[];var an={};var ak=0;var ag=[];do{aa[ak]=ad[ak].replace(/\W/g,"\\$&").toString();ag[ak]=new RegExp(aa[ak],"gi");ak++}while(ak<ad.length);for(var ak=0;ak<f.source.length;ak++){var aj=false;for(var ai=0;ai<ag.length;ai++){if(f.source[ak][f.field].match(ag[ai])){aj=true;if(f.and_or=="OR"){break}}else{aj=false;if(f.and_or=="AND"){break}}}if(aj){af.push(f.source[ak])}}if(af.length==undefined){F();return}an.cnt_whole=af.length;var aq=new RegExp("^"+aa[0]+"$","gi");var ao=new RegExp("^"+aa[0],"gi");var ap=[];var am=[];var al=[];for(var ak=0;ak<af.length;ak++){if(af[ak][f.order_field[0]].match(aq)){ap.push(af[ak])}else{if(af[ak][f.order_field[0]].match(ao)){am.push(af[ak])}else{al.push(af[ak])}}}if(f.order_by=="ASC"){ap.sort(Z);am.sort(Z);al.sort(Z)}else{ap.sort(Y);am.sort(Y);al.sort(Y)}X=X.concat(ap).concat(am).concat(al);function Z(au,at){return au[f.order_field[0]].localeCompare(at[f.order_field[0]])}function Y(au,at){return at[f.order_field[0]].localeCompare(au[f.order_field[0]])}var ac=(ah-1)*f.per_page;var ab=ac+f.per_page;for(var ak=ac,ae=0;ak<ab;ak++,ae++){if(X[ak]==undefined){break}for(var ar in X[ak]){if(ar==f.primary_key){if(an.primary_key==undefined){an.primary_key=[]}an.primary_key.push(X[ak][ar])}if(ar==f.field){if(an.candidate==undefined){an.candidate=[]}an.candidate.push(X[ak][ar])}else{if(b.inArray(ar,f.hide_field)==-1){if(f.show_field!=""&&b.inArray("*",f.show_field)==-1&&b.inArray(ar,f.show_field)==-1){continue}if(an.subinfo==undefined){an.subinfo=[]}if(an.subinfo[ae]==undefined){an.subinfo[ae]=[]}an.subinfo[ae][ar]=X[ak][ar]}}}}an.cnt_page=an.candidate.length;M(an,ad,ah)}function F(){b(C.navi_info).text(s.not_found);b(C.navi_p).hide();b(C.results).empty();b(C.sub_info).empty();b(C.result_area).show();b(C.container).addClass(G.container_open);w()}function M(aa,ab,Y){L(aa.cnt_whole,aa.cnt_page,Y);if(!aa.subinfo||!f.sub_info){aa.subinfo=false}if(!aa.primary_key){aa.primary_key=false}if(f.select_only&&aa.candidate.length===1&&aa.candidate[0]==ab[0]){b(C.hidden).val(aa.primary_key[0]);e()}T(aa.candidate,aa.subinfo,aa.primary_key);if(x.is_paging===false){w()}else{var X=x.is_paging;var Z=b(C.results).children("li").length-1;if(X>Z){X=Z}var ac=b(C.results).children("li").eq(X);b(ac).addClass(G.select);u(ac);x.is_paging=false;V()}}function L(ae,af,X){var ag=f.per_page*(X-1)+1;var ab=ag+af-1;var Y=s.page_info.replace("cnt_whole",ae).replace("num_page_top",ag).replace("num_page_end",ab);b(C.navi_info).text(Y);var aa=Math.ceil(ae/f.per_page);if(aa>1){b(C.navi_p).empty();if(x.is_suggest){x.max_suggest=aa}else{x.max_all=aa}var Z=X-Math.ceil((f.navi_num-1)/2);var ad=X+Math.floor((f.navi_num-1)/2);while(Z<1){Z++}ad++;while(ad>aa){ad--}while((ad-Z<f.navi_num-1)&&Z>1){Z--}if(X==1){if(!f.navi_simple){b("<span></span>").text("<< 1").addClass("page_end").appendTo(C.navi_p)}b("<span></span>").text(s.prev).addClass("page_end").appendTo(C.navi_p)}else{if(!f.navi_simple){b("<a></a>").attr({href:"javascript:void(0)","class":"navi_first"}).text("<< 1").attr("title",s.first_title).appendTo(C.navi_p)}b("<a></a>").attr({href:"javascript:void(0)","class":"navi_prev"}).text(s.prev).attr("title",s.prev_title).appendTo(C.navi_p)}for(i=Z;i<=ad;i++){var ac=(i==X)?'<span class="current">'+i+"</span>":i;b("<a></a>").attr({href:"javascript:void(0)","class":"navi_page"}).html(ac).appendTo(C.navi_p)}if(X==aa){b("<span></span>").text(s.next).addClass("page_end").appendTo(C.navi_p);if(!f.navi_simple){b("<span></span>").text(aa+" >>").addClass("page_end").appendTo(C.navi_p)}}else{b("<a></a>").attr({href:"javascript:void(0)","class":"navi_next"}).text(s.next).attr("title",s.next_title).appendTo(C.navi_p);if(!f.navi_simple){b("<a></a>").attr({href:"javascript:void(0)","class":"navi_last"}).text(aa+" >>").attr("title",s.last_title).appendTo(C.navi_p)}}b(C.navi_p).show();K()}else{b(C.navi_p).hide()}}function u(aa){if(!f.sub_info){return}x.size_results=(b(C.results).outerHeight()-b(C.results).height())/2;x.size_navi=b(C.navi).outerHeight();x.size_li=b(C.results).children("li:first").outerHeight();x.size_left=b(C.results).outerWidth();var X=b(C.results).children("li").index(aa);b(C.sub_info).children("dl").hide();var Y=0;if(b(C.navi).css("display")!="none"){Y+=x.size_navi}Y+=(x.size_results+x.size_li*X);var Z=x.size_left;Y+="px";Z+="px";b(C.sub_info).children("dl").eq(X).css({position:"absolute",top:Y,left:Z,display:"block"})}function T(ai,ae,af){b(C.results).empty();b(C.sub_info).empty();for(var ac=0;ac<ai.length;ac++){var ad=b("<li>").text(ai[ac]).attr({pkey:af[ac],title:ai[ac]});if(af[ac]==b(C.hidden).val()){b(ad).addClass(G.selected)}b(C.results).append(ad);if(ae){var ag=[];var Z=b("<dl>");for(key in ae[ac]){var X=key.replace("'","\\'");var ab=ae[ac][key].replace("'","\\'");ag.push("'"+X+"':'"+ab+"'");if(f.sub_as[key]!=null){var Y=f.sub_as[key]}else{var Y=key}Y=b("<dt>").text(Y);if(f.sub_info=="simple"){b(Y).addClass("hide")}Z.append(Y);var ah=b("<dd>").text(ae[ac][key]);Z.append(ah)}ag="{"+ag.join(",")+"}";b(ad).attr("sub_info",ag);b(C.sub_info).append(Z)}}var aa=b(C.combo_input).offset();b(C.result_area).css({top:aa.top+b(C.combo_input).outerHeight()+"px",left:aa.left+"px"}).show();b(C.container).addClass(G.container_open);o();b(C.button).attr("title",s.close_btn)}function c(){if(x.key_paging){h(true);x.key_paging=false}w();b(C.results).empty();b(C.sub_info).empty();b(C.result_area).hide();b(C.container).removeClass(G.container_open);P();e()}function t(){if(!x.is_suggest){if(x.page_all>1){x.page_all=1;x.is_paging=true;n()}}else{if(x.page_suggest>1){x.page_suggest=1;x.is_paging=true;n()}}}function J(){if(!x.is_suggest){if(x.page_all>1){x.page_all--;x.is_paging=true;n()}}else{if(x.page_suggest>1){x.page_suggest--;x.is_paging=true;n()}}}function W(){if(x.is_suggest){if(x.page_suggest<x.max_suggest){x.page_suggest++;x.is_paging=true;n()}}else{if(x.page_all<x.max_all){x.page_all++;x.is_paging=true;n()}}}function l(){if(!x.is_suggest){if(x.page_all<x.max_all){x.page_all=x.max_all;x.is_paging=true;n()}}else{if(x.page_suggest<x.max_suggest){x.page_suggest=x.max_suggest;x.is_paging=true;n()}}}function D(X){h(true);var Y=H();if(Y){b(C.combo_input).val(b(Y).text());if(f.sub_info){b(C.combo_input).attr("sub_info",b(Y).attr("sub_info"))}c();x.prev_value=b(C.combo_input).val();b(C.hidden).val(b(Y).attr("pkey"));if(f.select_only){e()}}if(f.bind_to){b(C.combo_input).trigger(f.bind_to,X)}b(C.combo_input).focus();b(C.combo_input).change();w()}function H(){if(b(C.result_area).is(":hidden")){return false}var X=b(C.results).children("li."+G.select);if(b(X).length){return X}else{return false}}function g(){var Z=H();if(!Z){var X=-1}else{var X=b(C.results).children("li").index(Z);b(Z).removeClass(G.select)}X++;if(X<b(C.results).children("li").length){var Y=b(C.results).children("li").eq(X);u(Y);b(Y).addClass(G.select);V()}else{w()}h()}function U(){var Z=H();if(!Z){var X=b(C.results).children("li").length}else{var X=b(C.results).children("li").index(Z);b(Z).removeClass(G.select)}X--;if(X>-1){var Y=b(C.results).children("li").eq(X);u(Y);b(Y).addClass(G.select);V()}else{w()}h()}}})(jQuery);